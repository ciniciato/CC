<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
        <title>CellCount</title>
		<link rel="stylesheet" href="assets/fonts/font-awesome/css/font-awesome.min.css">
        <link rel="stylesheet" href="style.css">
    </head>

    <body>    
		<div id="main_container">
			<canvas id="canvas"></canvas>
			<video id="video" autoplay></video>
			
			<span id="snap_button" onclick="control.snap();">
				<span class="inside"></span>
			</span>
			
			<span id="acceptmsg">
				<strong class="yes" onclick="message.confirm.callback(true);">YES!</strong>
				<strong class="no"  onclick="message.confirm.callback(false);">NO!</strong>
			</span>
			
			<span id="hint">
				TAKE A PHOTO!
			</span>
			<div id="top">
				<ul id="main_menu">
					<li>
						<i class="fa fa-image" aria-hidden="true"></i>
						<input class="loadFile" id="openFile" type="file" id="files" name="files[]" />
					</li>
					<li><i class="fa fa-camera" aria-hidden="true" onclick="control.takePhoto();"></i></li>
					<li><i class="fa fa-adjust" aria-hidden="true"></i></li>
					<li><i class="fa fa-crop" aria-hidden="true"></i></li>
					<li><i class="fa fa-gear" aria-hidden="true"></i></li>
				</ul>
			<div>
		</div>
			
        <script src=""></script>
        <!--INITIALIZATION-->
        <script>  
		// Grab elements, create settings, etc.
		
		var canvas = {
			realTime: false,
			img: null,
			imgData: null,
			state: 0,//0-cam,1-image,2-realTime
			top: 0,
			left: 0,
			w: 0,
			h: 0,
			video: document.getElementById('video'),
			obj: document.getElementById('canvas'),
			ctx: document.getElementById('canvas').getContext('2d'),
			container: document.getElementById('main_container')
		};
		
		canvas.changeState = function(value){
			this.state = value;
			this.video.style.display = (value==0) ? "block" : "none";
			this.obj.style.display   = (value==0) ? "none"  : "block";
			this.w = (value==0 || value==2) ? this.video.videoWidth : this.img.width;
			this.h = (value==0 || value==2) ? this.video.videoHeight : this.img.height;
			this.resize();
			if (value == 1)
			{
				this.ctx.drawImage(this.img, 0, 0, this.w, this.h);
				this.imgData = this.ctx.getImageData(0, 0, this.w, this.h);
				this.video.pause();
			}
			else
			{
				this.video.play();
			}
		}
		
		canvas.resize = function(){	
			var ch = this.container.offsetHeight,
				cw = this.container.offsetWidth,
				objscale  = this.w/this.h,
				canvasscale = cw/ch,
				w = h = 0;
			if (objscale>canvasscale)
			{
				w=cw;
				h=Math.round(w/objscale);
			}
			else
			{
				h=ch;
				w=Math.round(h*objscale);
			}
			var l = Math.round((cw-w)/2), 
				t = Math.round((ch-h)/2);
			
			canvas.w = this.obj.width  = this.video.width  = w;
			canvas.h = this.obj.height = this.video.height = h;
			
			canvas.top  = t; 
			this.obj.style.top = this.video.style.top = t+'px';
			canvas.left = l; 
			this.obj.style.left = this.video.style.left = l+'px';
		}
		
		canvas.loadImg = function(_path){
			var img = new Image();
			img.src = _path;
			var that = this;
			img.onload = function(){
				canvas.img = img;
				canvas.changeState(1);
				message.show('GREAT! Now choose the average point.');
			}	
		}
		
				
		window.onresize = function(event){
			canvas.changeState(canvas.state);
		}; 	
		
		var control = {
			timer: null
		}
		
		control.step = function(){
			window.requestAnimationFrame(control.step);
			if (canvas.video.readyState === canvas.video.HAVE_ENOUGH_DATA) {
				canvas.ctx.drawImage(canvas.video, 0, 0, canvas.w, canvas.h);
				var imageData = canvas.ctx.getImageData(0, 0, canvas.w, canvas.h),
					len = imageData.data.length;
				for (var i = 0; i < len; i+=4)
					imageData.data[i+1] = imageData.data[i+2] = 0  ;
				canvas.ctx.putImageData(imageData, 0, 0);
			}
		}
		
		control.init = function(){
			
			if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
				navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
					video.src = window.URL.createObjectURL(stream);
					video.play();
				});		
			
			document.getElementById('openFile').addEventListener('change', control.loadPhoto, false);
            canvas.video.addEventListener('loadeddata', 
				function(){
					canvas.changeState(2);
					control.timer =  setTimeout(
							function() {
								window.requestAnimationFrame(control.step);
							}, 
						500);
				}
			);
		}
				
		control.takePhoto = function(){
			canvas.changeState(0);
			document.getElementById('snap_button').style = 'display:block';
			message.show('TAKE A PHOTO!');
			message.confirm.hide();
		}
				
		control.loadPhoto = function(evt) {
			console.log
			var files = evt.target.files;
			for (var i = 0, f; f = files[i]; i++) {
			  if (!f.type.match('image.*'))
				continue;
			  var reader = new FileReader();
			  reader.onload = (function(theFile) {
				return function(e) {
					var path = e.target.result,
						fileName = escape(theFile.name);
					canvas.loadImg(path);
				};
			  })(f);
			  reader.readAsDataURL(f);
			}
		  }
		
		control.snap = function(){
			var el = document.getElementById('snap_button');
			el.style.display='none';
			
			
			clearTimeout(control.timer);
			canvas.img = canvas.video;
			canvas.changeState(1);
			
			message.show('Can we count on it?');
			message.confirm.show(
				function(value){	
					if (value)
					{
						message.show('GREAT! Now choose the average point.');
					}
					else
					{					
						control.takePhoto();
					}
				}
			);
		}
		
		var message = {
			el: document.getElementById('hint'),
			show: function(txt){
				this.el.innerHTML = txt;
			},
			confirm: {
				el: document.getElementById('acceptmsg'),
				doAfter: function(){},
				show: function(callback){
					this.el.style.display = 'block';
					this.doAfter = callback;
				},				
				callback: function(value){
					this.doAfter(value);
					this.hide();
				},
				hide: function(callback){
					this.el.style.display = 'none';
				}
			}
		}
		
		control.init();
		
        </script>
    </body>
</html>
 